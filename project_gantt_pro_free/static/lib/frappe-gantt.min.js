/*! Frappe Gantt (simplified build) | MIT License */
(function(){"use strict";var DAY_MS=86400000;function toDate(val){if(!val)return new Date();if(val instanceof Date)return new Date(val.getTime());return new Date(val)}function fmt(date){return date.toISOString().substring(0,10)}function clamp(v,min,max){return Math.max(min,Math.min(max,v))}function diffDays(a,b){return Math.round((b.getTime()-a.getTime())/DAY_MS)}function addDays(date,days){return new Date(date.getTime()+days*DAY_MS)}function createEl(tag,className,parent){var el=document.createElement(tag);if(className){el.className=className}if(parent){parent.appendChild(el)}return el}
function Gantt(wrapper,tasks,options){if(!wrapper)throw new Error("Frappe Gantt: wrapper element required");this.$wrapper=wrapper;this.options=Object.assign({view_modes:["Day","Week","Month"],view_mode:"Week",on_date_change:function(){},custom_popup_html:null},options||{});this._initTasks(tasks||[]);this.render()}
Gantt.prototype._initTasks=function(tasks){var self=this;this.tasks=(tasks||[]).map(function(task){var start=task.start||task._start||task._start_date;var end=task.end||task._end||task._end_date;if(!start&&task.start_date)start=task.start_date;if(!end&&task.end_date)end=task.end_date;var s=toDate(start);var e=toDate(end);if(e<s){e=addDays(s,1)}task.start=s;task.end=e;task._start=fmt(s);task._end=fmt(e);return Object.assign({},task)});if(!this.tasks.length){var today=new Date();this.tasks=[{id:"empty",name:"",start:today,end:addDays(today,1),progress:0,custom_class:""}]}this._computeBounds()};
Gantt.prototype._computeBounds=function(){var min=this.tasks[0].start.getTime(),max=this.tasks[0].end.getTime();this.tasks.forEach(function(task){min=Math.min(min,task.start.getTime());max=Math.max(max,task.end.getTime())});this.bounds={start:new Date(min),end:new Date(max)};if(diffDays(this.bounds.start,this.bounds.end)<2){this.bounds.end=addDays(this.bounds.start,2)}this.bounds.start=addDays(this.bounds.start,-2);this.bounds.end=addDays(this.bounds.end,2)};
Gantt.prototype._dayWidth=function(){switch(this.options.view_mode){case"Day":return 36;case"Month":return 8;case"Week":default:return 18}};
Gantt.prototype.render=function(){var container=this.$wrapper;container.classList.add("fg-gantt");container.innerHTML="";this._computeBounds();this._renderHeader();this._renderBody();};
Gantt.prototype._renderHeader=function(){var header=createEl("div","fg-header",this.$wrapper);var grid=createEl("div","fg-header-grid",header);var start=new Date(this.bounds.start.getTime());var end=this.bounds.end;var cursor=new Date(start.getTime());var mode=this.options.view_mode;var dayWidth=this._dayWidth();var step=mode==="Month"?30:mode==="Week"?7:1;while(cursor<=end){var cell=createEl("div","fg-header-cell",grid);cell.style.width=dayWidth*step+"px";if(mode==="Month"){cell.textContent=cursor.toLocaleString(undefined,{month:"short",year:"numeric"})}else if(mode==="Week"){cell.textContent="W"+getWeek(cursor)}else{cell.textContent=cursor.getDate().toString()}cursor=addDays(cursor,step)}function getWeek(d){var date=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));var dayNum=date.getUTCDay()||7;date.setUTCDate(date.getUTCDate()+4-dayNum);var yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1));return Math.ceil(((date-yearStart)/DAY_MS+1)/7)}};
Gantt.prototype._renderBody=function(){var body=createEl("div","fg-body",this.$wrapper);var labels=createEl("div","fg-labels",body);var grid=createEl("div","fg-grid",body);var bars=createEl("div","fg-bars",grid);var dayWidth=this._dayWidth();var boundsStart=this.bounds.start;var self=this;this.tasks.forEach(function(task,index){var row=createEl("div","fg-row",grid);row.style.height="32px";var label=createEl("div","fg-label",labels);label.textContent=task.name||("#"+task.id);label.style.height="32px";var bar=createEl("div","fg-bar",bars);bar.dataset.taskId=task.id;bar.style.top=index*32+"px";bar.style.height="24px";if(task.custom_class){bar.classList.add(task.custom_class)}var duration=Math.max(1,diffDays(task.start,task.end));var offset=Math.round(diffDays(boundsStart,task.start));bar.style.left=offset*dayWidth+"px";bar.style.width=Math.max(dayWidth,dayWidth*duration)+"px";var inner=createEl("div","fg-bar-inner",bar);if(task.progress){inner.style.width=clamp(task.progress,0,100)+"%";}createEl("div","fg-handle fg-handle-left",bar);createEl("div","fg-handle fg-handle-right",bar);self._makeDraggable(bar,task,dayWidth);bar.addEventListener("mouseenter",function(){self._showPopup(task,bar)});bar.addEventListener("mouseleave",function(){self._hidePopup()})});var width=Math.max(grid.scrollWidth,dayWidth*diffDays(this.bounds.start,this.bounds.end));grid.style.width=width+"px";bars.style.width=width+"px";body.scrollLeft=Math.max(0,dayWidth*diffDays(boundsStart,new Date())-200)};
Gantt.prototype._makeDraggable=function(bar,task,dayWidth){var self=this;var dragData=null;var mode="move";var pointerId=null;bar.addEventListener("pointerdown",function(ev){var target=ev.target;if(target.classList.contains("fg-handle-left")){mode="resize-start"}else if(target.classList.contains("fg-handle-right")){mode="resize-end"}else{mode="move"}pointerId=ev.pointerId;bar.setPointerCapture(pointerId);dragData={startX:ev.clientX,initialStart:new Date(task.start.getTime()),initialEnd:new Date(task.end.getTime())};ev.preventDefault();self._hidePopup()});bar.addEventListener("pointermove",function(ev){if(!dragData)return;var dx=ev.clientX-dragData.startX;var delta=Math.round(dx/dayWidth);if(!delta&&mode==="move")return;if(mode==="move"){var duration=Math.max(1,diffDays(dragData.initialStart,dragData.initialEnd));var newStart=addDays(dragData.initialStart,delta);var newEnd=addDays(newStart,duration);task.start=newStart;task.end=newEnd}else if(mode==="resize-start"){var newStart=addDays(dragData.initialStart,delta);if(newStart>=task.end){newStart=addDays(task.end,-1)}task.start=newStart}else if(mode==="resize-end"){var newEnd=addDays(dragData.initialEnd,delta);if(newEnd<=task.start){newEnd=addDays(task.start,1)}task.end=newEnd}task._start=fmt(task.start);task._end=fmt(task.end);bar.style.left=Math.round(diffDays(self.bounds.start,task.start))*dayWidth+"px";bar.style.width=Math.max(dayWidth,dayWidth*Math.max(1,diffDays(task.start,task.end)))+"px"});bar.addEventListener("pointerup",finish);bar.addEventListener("pointercancel",finish);function finish(){if(!dragData)return;bar.releasePointerCapture(pointerId);dragData=null;pointerId=null;Promise.resolve(self.options.on_date_change(task,new Date(task.start.getTime()),new Date(task.end.getTime()))).finally(function(){self.render()})}};
Gantt.prototype._showPopup=function(task,anchor){if(typeof this.options.custom_popup_html!=="function")return;this._hidePopup();var popup=createEl("div","fg-popup",this.$wrapper);popup.innerHTML=this.options.custom_popup_html(task);this.$wrapper.appendChild(popup);var anchorRect=anchor.getBoundingClientRect();var wrapperRect=this.$wrapper.getBoundingClientRect();popup.style.left=Math.max(0,anchorRect.left-wrapperRect.left)+"px";popup.style.top=Math.max(0,anchorRect.top-wrapperRect.top-popup.offsetHeight-12)+"px";this._popup=popup};
Gantt.prototype._hidePopup=function(){if(this._popup){this._popup.remove();this._popup=null}};
Gantt.prototype.change_view_mode=function(mode){if(this.options.view_modes.indexOf(mode)===-1)return;this.options.view_mode=mode;this.render()};
window.Gantt=Gantt;})();
